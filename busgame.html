<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pixel Bus Lights</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #111;
  }
  canvas {
    display: block;
    image-rendering: pixelated;
  }
</style>
</head>
<body>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  ctx.imageSmoothingEnabled = false;
}
window.addEventListener("resize", resize);
resize();

// SCENE 1 SETTINGS
const scene1Scale = 2.5;
const scene1GroundOffset = 40;
const gravity = 0.40;     // LOWER GRAVITY
const jumpPower = 15;     // HIGHER JUMP

// IMAGES
const playerImage = new Image();
playerImage.src = "https://iili.io/fZGS96u.png";

const scene2Image = new Image();
scene2Image.src =
  "https://thelvboys.odoo.com/web/image/6202?access_token=51c9f23a72cfe9e8cdafddfee962c94280b513893cbb6af202ead81ff30e04a9o0x69aa11c8&filename=pixelated-image%20(1).png&unique=71499ee79da9bee3268afde12db92c73a48279d4";

// STATE
let scene = 0;
let lightMode = 0;
let flashState = 0;
let flashTimer = 0;
const flashInterval = 15;
const lightSize = 28;
const keys = {};
let hazardsOn = false;
let glowEnabled = true;

// LIGHT POSITIONS
let redPosX = 55, redPosY = 60;
let orangePosX = 88, orangePosY = 60;
let brakeInnerX = 94, brakeInnerY = 205;
let brakeOuterX = 61, brakeOuterY = 205;

// PLAYER
const player = {
  width: 400,
  height: 400,
  x: window.innerWidth / 2 - 200,
  y: window.innerHeight * 0.4,
  vy: 0,
  onGround: false,
  speed: 7
};

// INPUT
window.onkeydown = e => {
  const k = e.key.toLowerCase();
  keys[k] = true;

  if (k === "f" && scene === 0) {
    lightMode = (lightMode + 1) % 3;
    flashTimer = 0;
  }

  if (k === "h" && scene === 0) {
    hazardsOn = !hazardsOn;
    flashTimer = 0;
  }

  if (k === "q") {
    scene = scene === 0 ? 1 : 0;
    lightMode = 0;
    hazardsOn = false;
    player.vy = 0;
    player.onGround = false;

    // CENTER SCENE 1 IMAGE
    if (scene === 1 && scene2Image.complete) {
      const w = scene2Image.naturalWidth * scene1Scale;
      const h = scene2Image.naturalHeight * scene1Scale;
      player.x = (canvas.width - w) / 2;
      player.y = (canvas.height - h) / 2;
    } else {
      player.x = window.innerWidth / 2 - 200;
      player.y = window.innerHeight * 0.4;
    }
  }

  if (k === "w" && scene === 1 && player.onGround) {
    player.vy = -jumpPower;
    player.onGround = false;
  }
};

window.onkeyup = e => keys[e.key.toLowerCase()] = false;

// UPDATE
function update() {
  if (keys["a"] || keys["arrowleft"]) player.x -= player.speed;
  if (keys["d"] || keys["arrowright"]) player.x += player.speed;

  if (scene === 1 && scene2Image.complete) {
    // Gravity / jump
    player.vy += gravity;
    player.y += player.vy;

    const imgH = scene2Image.naturalHeight * scene1Scale;
    const groundY = canvas.height - imgH - scene1GroundOffset;

    if (player.y >= groundY) {
      player.y = groundY;
      player.vy = 0;
      player.onGround = true;
    }

    const imgW = scene2Image.naturalWidth * scene1Scale;
    player.x = Math.max(0, Math.min(canvas.width - imgW, player.x));
  } else {
    player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
  }

  if (scene === 0 && (lightMode > 0 || keys["a"] || keys["d"] || hazardsOn)) {
    flashTimer++;
    if (flashTimer > flashInterval) {
      flashState = 1 - flashState;
      flashTimer = 0;
    }
  }
}

// PIXEL LIGHT WITH GLOW
function drawPixelCircle(x, y, size, color) {
  const pixel = 4;
  const r = size / 2;

  ctx.fillStyle = color;
  ctx.shadowColor = color;
  ctx.shadowBlur = glowEnabled ? 16 : 0;

  for (let dx = -r; dx <= r; dx += pixel) {
    for (let dy = -r; dy <= r; dy += pixel) {
      if (dx * dx + dy * dy <= r * r) {
        ctx.fillRect(
          Math.round((x + dx) / pixel) * pixel,
          Math.round((y + dy) / pixel) * pixel,
          pixel,
          pixel
        );
      }
    }
  }
  ctx.shadowBlur = 0;
}

// DRAW
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (scene === 1 && scene2Image.complete) {
    const w = scene2Image.naturalWidth * scene1Scale;
    const h = scene2Image.naturalHeight * scene1Scale;
    ctx.drawImage(scene2Image, player.x, player.y, w, h);
    return;
  }

  // Scene 0 (bus)
  ctx.drawImage(playerImage, player.x, player.y, player.width, player.height);

  const lx = player.x;
  const rx = player.x + player.width;

  if (lightMode === 1 && flashState === 0)
    drawPixelCircle(lx + orangePosX, player.y + orangePosY, lightSize, "orange");
  if (lightMode === 1 && flashState === 1)
    drawPixelCircle(rx - orangePosX, player.y + orangePosY, lightSize, "orange");

  if (lightMode === 2 && flashState === 0)
    drawPixelCircle(lx + redPosX, player.y + redPosY, lightSize, "red");
  if (lightMode === 2 && flashState === 1)
    drawPixelCircle(rx - redPosX, player.y + redPosY, lightSize, "red");

  if (keys["s"]) {
    drawPixelCircle(lx + brakeInnerX, player.y + brakeInnerY, lightSize, "red");
    drawPixelCircle(rx - brakeInnerX, player.y + brakeInnerY, lightSize, "red");
  }

  if (hazardsOn && flashState === 0) {
    drawPixelCircle(lx + brakeOuterX, player.y + brakeOuterY, lightSize, "yellow");
    drawPixelCircle(rx - brakeOuterX, player.y + brakeOuterY, lightSize, "yellow");
  }

  if (!hazardsOn && keys["a"] && flashState === 0)
    drawPixelCircle(lx + brakeOuterX, player.y + brakeOuterY, lightSize, "yellow");

  if (!hazardsOn && keys["d"] && flashState === 0)
    drawPixelCircle(rx - brakeOuterX, player.y + brakeOuterY, lightSize, "yellow");
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

playerImage.onload = loop;
playerImage.onerror = loop;
</script>

</body>
</html>
